#!/usr/bin/env python3
"""
Generate golden dataset for evaluation with the new dummy database schema.
"""

import json
import sqlite3
from pathlib import Path
from typing import List, Dict, Any, Optional


def load_db(db_path: str = "Chinook.db") -> sqlite3.Connection:
    """Load the SQLite database and return a connection."""
    db_file = Path(db_path)
    if not db_file.exists():
        raise FileNotFoundError(f"Database file not found: {db_path}")

    conn = sqlite3.connect(db_path)
    conn.execute("PRAGMA foreign_keys = ON")
    conn.row_factory = sqlite3.Row
    return conn


def query_db(conn: sqlite3.Connection, query: str) -> List[Dict[str, Any]]:
    """Execute a SQL query and return results as a list of dictionaries."""
    try:
        cursor = conn.cursor()
        cursor.execute(query)
        columns = [description[0] for description in cursor.description]
        results = []
        for row in cursor.fetchall():
            results.append(dict(zip(columns, row)))
        return results
    except sqlite3.Error as e:
        raise sqlite3.Error(f"Error executing query: {e}")


def test_query(conn: sqlite3.Connection, sql: str, description: str):
    """Test a SQL query and return the results if valid."""
    try:
        result = query_db(conn, sql)
        print(f"✓ {description}")
        print(f"  Returned {len(result)} rows")
        return True, result
    except Exception as e:
        print(f"✗ {description}")
        print(f"  Error: {e}")
        return False, None


def main():
    # Load database
    conn = load_db()
    print("Database loaded successfully!\n")

    test_cases = [
        # Simple filtering
        {
            "question": "What are the names and emails of all active drivers?",
            "sql": "SELECT first_name, last_name, email FROM drivers WHERE status = 'active'",
            "category": "simple_filtering",
        },
        {
            "question": "List all trips that were completed",
            "sql": "SELECT trip_id, driver_id, customer_id, total_amount FROM trips WHERE trip_status = 'completed'",
            "category": "simple_filtering",
        },
        {
            "question": "What are the names of all cities in California?",
            "sql": "SELECT city_name FROM cities WHERE state = 'California'",
            "category": "simple_filtering",
        },
        
        # Simple aggregations
        {
            "question": "How many trips does each city have?",
            "sql": "SELECT c.city_name, COUNT(t.trip_id) as trip_count FROM cities c LEFT JOIN trips t ON c.city_id = t.pickup_city_id GROUP BY c.city_id, c.city_name ORDER BY trip_count DESC",
            "category": "simple_aggregation",
        },
        {
            "question": "What is the total number of trips in the database?",
            "sql": "SELECT COUNT(*) as total_trips FROM trips",
            "category": "simple_aggregation",
        },
        {
            "question": "What is the average trip amount?",
            "sql": "SELECT AVG(total_amount) as avg_amount FROM trips",
            "category": "simple_aggregation",
        },
        {
            "question": "How many drivers are in each city?",
            "sql": "SELECT c.city_name, COUNT(d.driver_id) as driver_count FROM cities c LEFT JOIN drivers d ON c.city_id = d.city_id GROUP BY c.city_id, c.city_name ORDER BY driver_count DESC",
            "category": "simple_aggregation",
        },
        
        # Aggregations with joins
        {
            "question": "What are the top 5 cities by total trip revenue?",
            "sql": "SELECT c.city_name, SUM(t.total_amount) as total_revenue FROM cities c JOIN trips t ON c.city_id = t.pickup_city_id GROUP BY c.city_id, c.city_name ORDER BY total_revenue DESC LIMIT 5",
            "category": "aggregation_with_joins",
        },
        {
            "question": "Which driver has completed the most trips?",
            "sql": "SELECT d.first_name || ' ' || d.last_name as driver_name, COUNT(t.trip_id) as trip_count FROM drivers d JOIN trips t ON d.driver_id = t.driver_id WHERE t.trip_status = 'completed' GROUP BY d.driver_id, d.first_name, d.last_name ORDER BY trip_count DESC LIMIT 1",
            "category": "aggregation_with_joins",
        },
        {
            "question": "What is the average rating for each driver?",
            "sql": "SELECT d.first_name || ' ' || d.last_name as driver_name, AVG(t.rating) as avg_rating FROM drivers d LEFT JOIN trips t ON d.driver_id = t.driver_id AND t.rating IS NOT NULL GROUP BY d.driver_id, d.first_name, d.last_name HAVING COUNT(t.rating) > 0 ORDER BY avg_rating DESC",
            "category": "aggregation_with_joins",
        },
        {
            "question": "What is the total revenue generated by each vehicle type?",
            "sql": "SELECT v.vehicle_type, SUM(t.total_amount) as total_revenue FROM vehicles v JOIN trips t ON v.vehicle_id = t.vehicle_id GROUP BY v.vehicle_type ORDER BY total_revenue DESC",
            "category": "aggregation_with_joins",
        },
        
        # Date/time filtering
        {
            "question": "How many trips were completed in the last 7 days?",
            "sql": "SELECT COUNT(*) as trip_count FROM trips WHERE trip_status = 'completed' AND pickup_time >= datetime('now', '-7 days')",
            "category": "date_filtering",
        },
        {
            "question": "What is the total revenue from completed trips in December 2025?",
            "sql": "SELECT SUM(total_amount) as total_revenue FROM trips WHERE trip_status = 'completed' AND strftime('%Y-%m', pickup_time) = '2025-12'",
            "category": "date_filtering",
        },
        {
            "question": "List all trips scheduled for today",
            "sql": "SELECT trip_id, driver_id, customer_id, pickup_time FROM trips WHERE trip_status = 'scheduled' AND date(pickup_time) = date('now')",
            "category": "date_filtering",
        },
        
        # Complex joins
        {
            "question": "Show trip details with driver name, customer name, and pickup city",
            "sql": "SELECT t.trip_id, d.first_name || ' ' || d.last_name as driver_name, c.first_name || ' ' || c.last_name as customer_name, ci.city_name as pickup_city, t.total_amount FROM trips t JOIN drivers d ON t.driver_id = d.driver_id JOIN customers c ON t.customer_id = c.customer_id JOIN cities ci ON t.pickup_city_id = ci.city_id LIMIT 10",
            "category": "complex_joins",
        },
        {
            "question": "What are the top 5 customers by total spending?",
            "sql": "SELECT c.first_name || ' ' || c.last_name as customer_name, SUM(t.total_amount) as total_spent FROM customers c JOIN trips t ON c.customer_id = t.customer_id WHERE t.trip_status = 'completed' GROUP BY c.customer_id, c.first_name, c.last_name ORDER BY total_spent DESC LIMIT 5",
            "category": "complex_joins",
        },
        {
            "question": "Which vehicle make and model has the most trips?",
            "sql": "SELECT v.make, v.model, COUNT(t.trip_id) as trip_count FROM vehicles v JOIN trips t ON v.vehicle_id = t.vehicle_id GROUP BY v.make, v.model ORDER BY trip_count DESC LIMIT 1",
            "category": "complex_joins",
        },
        
        # Filtering with joins
        {
            "question": "List all trips in Seattle with driver names",
            "sql": "SELECT t.trip_id, d.first_name || ' ' || d.last_name as driver_name, t.total_amount FROM trips t JOIN drivers d ON t.driver_id = d.driver_id JOIN cities c ON t.pickup_city_id = c.city_id WHERE c.city_name = 'Seattle'",
            "category": "filtering_with_join",
        },
        {
            "question": "Show all active drivers in New York",
            "sql": "SELECT d.first_name, d.last_name, d.email, d.rating FROM drivers d JOIN cities c ON d.city_id = c.city_id WHERE d.status = 'active' AND c.city_name = 'New York'",
            "category": "filtering_with_join",
        },
        {
            "question": "What are the completed trips for Tesla vehicles?",
            "sql": "SELECT t.trip_id, t.total_amount, t.pickup_time FROM trips t JOIN vehicles v ON t.vehicle_id = v.vehicle_id WHERE v.make = 'Tesla' AND t.trip_status = 'completed'",
            "category": "filtering_with_join",
        },
        
        # Sorting and limiting
        {
            "question": "What are the 10 most expensive trips?",
            "sql": "SELECT trip_id, driver_id, customer_id, total_amount FROM trips ORDER BY total_amount DESC LIMIT 10",
            "category": "simple_sorting",
        },
        {
            "question": "Show the top 5 highest rated drivers",
            "sql": "SELECT first_name || ' ' || last_name as driver_name, rating, total_trips FROM drivers WHERE rating IS NOT NULL ORDER BY rating DESC LIMIT 5",
            "category": "simple_sorting",
        },
        {
            "question": "What are the longest trips by duration?",
            "sql": "SELECT trip_id, distance_miles, duration_minutes, total_amount FROM trips WHERE duration_minutes IS NOT NULL ORDER BY duration_minutes DESC LIMIT 5",
            "category": "simple_sorting",
        },
        
        # Group by with having
        {
            "question": "Which drivers have completed more than 20 trips?",
            "sql": "SELECT d.first_name || ' ' || d.last_name as driver_name, COUNT(t.trip_id) as trip_count FROM drivers d JOIN trips t ON d.driver_id = t.driver_id WHERE t.trip_status = 'completed' GROUP BY d.driver_id, d.first_name, d.last_name HAVING COUNT(t.trip_id) > 20 ORDER BY trip_count DESC",
            "category": "group_by_having",
        },
        {
            "question": "What cities have more than 100 trips?",
            "sql": "SELECT c.city_name, COUNT(t.trip_id) as trip_count FROM cities c JOIN trips t ON c.city_id = t.pickup_city_id GROUP BY c.city_id, c.city_name HAVING COUNT(t.trip_id) > 100 ORDER BY trip_count DESC",
            "category": "group_by_having",
        },
        
        # Trip status analysis
        {
            "question": "How many trips are in each status?",
            "sql": "SELECT trip_status, COUNT(*) as count FROM trips GROUP BY trip_status ORDER BY count DESC",
            "category": "simple_aggregation",
        },
        {
            "question": "What is the average trip amount for each trip status?",
            "sql": "SELECT trip_status, AVG(total_amount) as avg_amount, COUNT(*) as count FROM trips GROUP BY trip_status ORDER BY avg_amount DESC",
            "category": "simple_aggregation",
        },
        
        # Payment and promotions
        {
            "question": "What is the total revenue by payment method?",
            "sql": "SELECT payment_method, SUM(total_amount) as total_revenue, COUNT(*) as trip_count FROM trips WHERE payment_method IS NOT NULL GROUP BY payment_method ORDER BY total_revenue DESC",
            "category": "simple_aggregation",
        },
        {
            "question": "How many trips used promotions?",
            "sql": "SELECT COUNT(DISTINCT trip_id) as trips_with_promotions FROM trip_promotions",
            "category": "simple_aggregation",
        },
        {
            "question": "What is the total discount applied from promotions?",
            "sql": "SELECT SUM(discount_applied) as total_discount FROM trip_promotions",
            "category": "simple_aggregation",
        },
        
        # Customer analysis
        {
            "question": "What is the average lifetime value of customers?",
            "sql": "SELECT AVG(lifetime_value) as avg_lifetime_value FROM customers",
            "category": "simple_aggregation",
        },
        {
            "question": "How many customers signed up in each month?",
            "sql": "SELECT strftime('%Y-%m', signup_date) as signup_month, COUNT(*) as customer_count FROM customers WHERE signup_date IS NOT NULL GROUP BY signup_month ORDER BY signup_month DESC",
            "category": "date_filtering",
        },
        
        # Driver performance
        {
            "question": "What is the average trip count per driver?",
            "sql": "SELECT AVG(total_trips) as avg_trips FROM drivers",
            "category": "simple_aggregation",
        },
        {
            "question": "Show drivers with their total completed trips and average rating",
            "sql": "SELECT d.first_name || ' ' || d.last_name as driver_name, COUNT(t.trip_id) as completed_trips, AVG(t.rating) as avg_rating FROM drivers d LEFT JOIN trips t ON d.driver_id = t.driver_id AND t.trip_status = 'completed' AND t.rating IS NOT NULL GROUP BY d.driver_id, d.first_name, d.last_name HAVING COUNT(t.trip_id) > 0 ORDER BY completed_trips DESC LIMIT 10",
            "category": "aggregation_with_joins",
        },
    ]

    print("Testing SQL queries...\n")
    print("=" * 80)

    valid_cases = []
    for i, test_case in enumerate(test_cases, 1):
        print(f"\n{i}. {test_case['question']}")
        success, results = test_query(conn, test_case["sql"], f"Query {i}")
        if success:
            valid_cases.append(
                {
                    "question": test_case["question"],
                    "sql": test_case["sql"],
                    "category": test_case["category"],
                    "expected_result": results,
                }
            )

    print("\n" + "=" * 80)
    print(f"\nValidated {len(valid_cases)}/{len(test_cases)} queries successfully!")

    # Save to evaluation_data.json in the current directory
    output_file = "evaluation_data.json"
    with open(output_file, "w") as f:
        json.dump(valid_cases, f, indent=2)

    print(f"\nEvaluation data saved to {output_file}")
    print(f"Total test cases: {len(valid_cases)}")
    print(f"Each test case includes the expected query results for validation.")
    
    # Print category breakdown
    categories = {}
    for case in valid_cases:
        cat = case.get("category", "unknown")
        categories[cat] = categories.get(cat, 0) + 1
    
    print("\nCategory breakdown:")
    for cat, count in sorted(categories.items()):
        print(f"  {cat}: {count}")

    conn.close()


if __name__ == "__main__":
    main()

